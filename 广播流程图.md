# 广播流程图

基于技术设计文档3.2.1流程图风格和unicast_service.go代码逻辑绘制的广播流程图。

## 流程图

```mermaid
sequenceDiagram
    participant UC as Upstream Client
    participant G as GateSvr
    participant SM as Session Manager
    participant S1 as Session 1
    participant S2 as Session 2
    participant SN as Session N
    participant C1 as QUIC Client 1
    participant C2 as QUIC Client 2
    participant CN as QUIC Client N
    
    Note over UC,CN: 1. 广播请求阶段
    UC->>+G: BroadcastToClients(msgType, title, content, data)
    G->>G: 接收广播请求
    
    Note over UC,CN: 2. 会话获取与筛选阶段
    G->>+SM: GetAllSessions()
    SM-->>-G: 返回所有会话列表
    G->>G: 筛选活跃会话(IsNormal && !IsClosed)
    
    Note over UC,CN: 3. 消息构建阶段
    G->>G: 构建BusinessResponse<br/>Code:200, Message:"[msgType] title"<br/>Data:req.Data
    G->>G: 序列化广播消息<br/>proto.Marshal(businessResp)
    
    Note over UC,CN: 4. 并行广播发送阶段
    
    par 发送到Session 1
        G->>+S1: sendBroadcastMessage()
        S1->>S1: 检查会话状态(!IsClosed)
        S1->>S1: orderedSender.PushBusinessData()
        S1->>S1: 获取新的服务器序列号
        S1->>S1: 通过有序队列发送
        S1-->>C1: ServerPush(广播消息)
        C1->>S1: ClientAck
        S1-->>-G: 发送成功
    and 发送到Session 2
        G->>+S2: sendBroadcastMessage()
        S2->>S2: 检查会话状态(!IsClosed)
        S2->>S2: orderedSender.PushBusinessData()
        S2->>S2: 获取新的服务器序列号
        S2->>S2: 通过有序队列发送
        S2-->>C2: ServerPush(广播消息)
        C2->>S2: ClientAck
        S2-->>-G: 发送成功
    and 发送到Session N
        G->>+SN: sendBroadcastMessage()
        SN->>SN: 检查会话状态(!IsClosed)
        SN->>SN: orderedSender.PushBusinessData()
        SN->>SN: 获取新的服务器序列号
        SN->>SN: 通过有序队列发送
        SN-->>CN: ServerPush(广播消息)
        CN->>SN: ClientAck
        SN-->>-G: 发送成功
    end
    
    Note over UC,CN: 5. 统计与响应阶段
    G->>G: 统计发送结果<br/>successCount++
    G->>G: 构建广播响应<br/>SentCount, Message
    G-->>-UC: BroadcastResponse<br/>(successCount/totalCount)
    
    Note over UC,CN: 6. 错误处理流程
    alt 会话状态异常
        G->>G: 跳过非Normal或已关闭会话
        G->>G: 记录日志但继续处理其他会话
    else 消息发送失败
        G->>G: 记录错误日志
        G->>G: 继续处理下一个会话
    else 序列化失败
        G->>G: 返回序列化错误
        G-->>UC: 广播失败响应
    end
```

## 广播流程关键特点

1. **会话筛选**: 只向`IsNormal() && !IsClosed()`的活跃会话广播
2. **消息统一**: 所有客户端收到相同格式的BusinessResponse消息
3. **并行发送**: 对所有目标会话并行执行广播，提高效率
4. **有序保证**: 每个会话内的消息通过有序队列保证顺序性
5. **错误容错**: 单个会话发送失败不影响其他会话的广播
6. **统计反馈**: 返回成功发送的会话数量和总会话数

## 代码位置参考

- 广播服务实现: `internal/gateway/unicast_service.go:79-109`
- 广播消息发送: `internal/gateway/unicast_service.go:111-133`
- 会话管理器: `internal/session/manager.go`
- 有序发送器: 通过`orderedSender.PushBusinessData()`调用